name: Verify

on: push

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest

    env:
      failed: "false"

    steps:
      - uses: actions/checkout@main
      - uses: cachix/install-nix-action@master

      - name: Check
        run: |
          sudo mkdir -p /etc/nixos
          echo '{ nixpkgs.hostPlatform = "x86_64-linux"; }' | sudo tee /etc/nixos/hardware.nix > /dev/null

          nix flake check --impure --option keep-going true || echo "failed=true" >> "$GITHUB_ENV"

      - name: Lint Nix
        run: |
          find . -name "*.nix" | while read -r file; do
            echo "Checking $file"
            diagnostics="$(nix run nixpkgs#nil -- diagnostics "$file")"

            if [ -n "$diagnostics" ]; then
              echo "$diagnostics"
              echo "failed=true" >> "$GITHUB_ENV"
            fi
          done

      - name: Lint Shell
        run: |
          find . -name "*.sh" | while read -r file; do
            echo "Checking $file"
            nix run nixpkgs#shellcheck -- "$file" || echo "failed=true" >> "$GITHUB_ENV"
          done

      - name: Fail
        if: env.failed == 'true'
        run: exit 1
