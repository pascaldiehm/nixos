name: Verify
on: push

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main

      - uses: cachix/install-nix-action@master
        with:
          extra_nix_config: "experimental-features = flakes nix-command pipe-operators"

      - name: Check
        if: ${{ !cancelled() }}
        run: |
          sudo mkdir -p /etc/nixos
          echo '{ nixpkgs.hostPlatform = "x86_64-linux"; }' | sudo tee /etc/nixos/hardware.nix > /dev/null

          nix flake check --impure --option keep-going true

      - name: Check default.nix imports
        if: ${{ !cancelled() }}
        run: |
          failed="false"

          find . -name default.nix | grep -v "./pkgs" | while read -r default; do
            echo "Checking $default"
            used="$(nix eval --json --file "$default" imports | jq -r ".[]")"

            ls "$(dirname "$default")" | grep -v default.nix | while read -r module; do
              if echo "$used" | grep "$module" > /dev/null; then
                echo "  - $module"
              else
                echo "  - $module (missing)"
                failed="true"
              fi
            done
          done

          [ "$failed" = "false" ] || exit 1

      - name: Check unused resources
        if: ${{ !cancelled() }}
        run: |
          failed="false"
          used="$(find . -type f | grep -E -v "(.git|resources)" | xargs cat | grep "resources")"

          find resources -type f | grep -v "secrets" | while read -r file; do
            if echo "$used" | grep "$file" > /dev/null; then
              echo "Checking $file"
            else
              echo "Checking $file - failed"
              failed="true"
            fi
          done

          [ "$failed" = "false" ] || exit 1

      - name: Lint Nix
        if: ${{ !cancelled() }}
        run: |
          failed="false"

          find . -name "*.nix" | while read -r file; do
            echo "Checking $file"
            diagnostics="$(nix run github:oxalica/nil -- diagnostics "$file")"

            if [ -n "$diagnostics" ]; then
              echo "$diagnostics"
              failed="true"
            fi
          done

          [ "$failed" = "false" ] || exit 1

      - name: Lint Shell
        if: ${{ !cancelled() }}
        run: |
          failed="false"

          find . -name "*.sh" | while read -r file; do
            echo "Checking $file"
            nix run nixpkgs#shellcheck -- "$file" || failed="true"
          done

          [ "$failed" = "false" ] || exit 1
